<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mobilya Takip – Kurulum Sihirbazı</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --border: #334155;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --success: #22c55e;
      --error: #ef4444;
      --radius: 10px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      min-height: 100vh;
      padding: 2rem;
      line-height: 1.5;
    }
    .container { max-width: 560px; margin: 0 auto; }
    h1 {
      font-size: 1.5rem;
      margin: 0 0 0.5rem;
      color: var(--text);
    }
    .sub { color: var(--muted); font-size: 0.95rem; margin-bottom: 1.5rem; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    .step-title {
      font-weight: 600;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .step-num {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
    }
    label {
      display: block;
      margin-top: 0.75rem;
      margin-bottom: 0.25rem;
      color: var(--muted);
      font-size: 0.9rem;
    }
    input[type="text"],
    input[type="number"],
    input[type="password"] {
      width: 100%;
      padding: 0.6rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg);
      color: var(--text);
      font-size: 1rem;
    }
    input:focus {
      outline: none;
      border-color: var(--primary);
    }
    .row { display: flex; gap: 1rem; }
    .row > * { flex: 1; }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 6px;
      font-size: 0.95rem;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }
    .btn-primary {
      background: var(--primary);
      color: white;
      margin-top: 1rem;
    }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-secondary {
      background: var(--border);
      color: var(--text);
      margin-right: 0.5rem;
    }
    .btn-secondary:hover { background: #475569; }
    .msg {
      margin-top: 0.75rem;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    .msg.ok { background: rgba(34, 197, 94, 0.2); color: var(--success); }
    .msg.err { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
    .msg.info { background: rgba(59, 130, 246, 0.2); color: #93c5fd; }
    .hidden { display: none !important; }
    .progress {
      margin: 1rem 0;
      font-size: 0.9rem;
      color: var(--muted);
    }
    .progress .done { color: var(--success); }
    #step5 .log {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.75rem;
      font-family: monospace;
      font-size: 0.8rem;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 0.5rem;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .checkbox { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; }
    .checkbox input { width: auto; }
    a { color: var(--primary); }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Mobilya Takip – Kurulum Sihirbazı</h1>
    <p class="sub">Veritabanı, uygulama ve isteğe bağlı mail ayarlarını yapıp tüm testleri geçtikten sonra kurulumu tamamlayın.</p>

    <div id="step1" class="card">
      <div class="step-title"><span class="step-num">1</span> Gereksinimler</div>
      <p class="progress">Node sürümü ve kurulum API’si kontrol ediliyor…</p>
      <div id="step1Msg" class="msg hidden"></div>
    </div>

    <div id="step2" class="card">
      <div class="step-title"><span class="step-num">2</span> Veritabanı (MySQL)</div>
      <label>Sunucu (host)</label>
      <input type="text" id="dbHost" value="127.0.0.1" placeholder="127.0.0.1">
      <label>Port</label>
      <input type="number" id="dbPort" value="3306" placeholder="3306">
      <label>Kullanıcı</label>
      <input type="text" id="dbUser" value="root" placeholder="root">
      <label>Şifre</label>
      <input type="password" id="dbPassword" placeholder="">
      <label>Veritabanı adı</label>
      <input type="text" id="dbName" value="mobilyatakip" placeholder="mobilyatakip">
      <div class="checkbox">
        <input type="checkbox" id="dbCreate" checked>
        <label for="dbCreate" style="margin:0">Veritabanı yoksa oluştur</label>
      </div>
      <button type="button" class="btn btn-secondary" id="btnTestDb">Bağlantıyı test et</button>
      <div id="step2Msg" class="msg hidden"></div>
    </div>

    <div id="step3" class="card">
      <div class="step-title"><span class="step-num">3</span> Uygulama</div>
      <label>JWT Gizli Anahtar (üretmek için <a href="#" id="genJwt">tıklayın</a>)</label>
      <input type="text" id="jwtSecret" placeholder="En az 16 karakter">
      <label>Port</label>
      <input type="number" id="port" value="3001" placeholder="3001">
      <label>Uygulama URL (sunucu adresi, sonunda / olmasın)</label>
      <input type="text" id="appUrl" placeholder="https://alanadi.com veya http://sunucu:3001">
      <label>Frontend URL (genelde uygulama URL ile aynı)</label>
      <input type="text" id="frontendUrl" placeholder="APP_URL ile aynı bırakılabilir">
      <div id="step3Msg" class="msg hidden"></div>
    </div>

    <div id="step4" class="card">
      <div class="step-title"><span class="step-num">4</span> Mail (opsiyonel)</div>
      <label>SMTP Sunucu</label>
      <input type="text" id="mailHost" placeholder="smtp.example.com">
      <label>Port</label>
      <input type="number" id="mailPort" value="587" placeholder="587">
      <label>Kullanıcı</label>
      <input type="text" id="mailUser" placeholder="">
      <label>Şifre</label>
      <input type="password" id="mailPassword" placeholder="">
      <label>Gönderen adresi</label>
      <input type="text" id="mailFrom" placeholder="Mobilya Takip &lt;noreply@example.com&gt;">
      <div id="step4Msg" class="msg hidden"></div>
    </div>

    <div id="step5" class="card">
      <div class="step-title"><span class="step-num">5</span> Kurulumu çalıştır</div>
      <p>Tüm adımları doldurup veritabanı bağlantısını test ettikten sonra aşağıdaki butonla kurulumu başlatın. Config yazılacak, şema oluşturulacak ve frontend derlenecek.</p>
      <button type="button" class="btn btn-primary" id="btnRun">Kurulumu başlat</button>
      <div id="step5Msg" class="msg hidden"></div>
      <div id="step5Log" class="log hidden"></div>
      <div id="step5Done" class="hidden">
        <p class="msg ok">Kurulum tamamlandı. Uygulamayı yeniden başlatın (INSTALL_MODE=0 ile). Ardından <a id="linkLogin" href="/giris">giriş sayfasına</a> gidin. Varsayılan admin: <strong>erkanulker0@gmail.com</strong> / <strong>password</strong> (ilk girişte şifreyi değiştirin).</p>
      </div>
    </div>
  </div>

  <script>
    const API = '/api/install';

    function showMsg(elId, text, type) {
      const el = document.getElementById(elId);
      if (!el) return;
      el.textContent = text;
      el.className = 'msg ' + (type === 'ok' ? 'ok' : type === 'err' ? 'err' : 'info');
      el.classList.remove('hidden');
    }
    function hideMsg(elId) {
      const el = document.getElementById(elId);
      if (el) el.classList.add('hidden');
    }

    async function fetchJson(url, opts = {}) {
      const r = await fetch(url, { headers: { 'Content-Type': 'application/json' }, ...opts });
      const text = await r.text();
      let data;
      try { data = JSON.parse(text); } catch { throw new Error(text || r.statusText); }
      if (!r.ok) throw new Error(data.message || data.error || text);
      return data;
    }

    document.getElementById('genJwt').addEventListener('click', (e) => {
      e.preventDefault();
      const arr = new Uint8Array(24);
      crypto.getRandomValues(arr);
      document.getElementById('jwtSecret').value = Array.from(arr, x => x.toString(16).padStart(2, '0')).join('');
    });

    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const st = await fetchJson(API + '/status');
        const el = document.getElementById('step1Msg');
        if (st.installMode) {
          el.textContent = 'Kurulum modu açık. Node: ' + st.nodeVersion + ', Çalışma dizini: ' + st.cwd;
          el.className = 'msg ok';
        } else {
          el.textContent = 'Kurulum modu kapalı. Kurulum zaten yapılmış olabilir.';
          el.className = 'msg info';
        }
        el.classList.remove('hidden');
      } catch (err) {
        showMsg('step1Msg', 'Kurulum API\'sine ulaşılamadı: ' + (err.message || err), 'err');
      }
    });

    document.getElementById('btnTestDb').addEventListener('click', async () => {
      hideMsg('step2Msg');
      const btn = document.getElementById('btnTestDb');
      btn.disabled = true;
      btn.textContent = 'Test ediliyor…';
      try {
        const res = await fetchJson(API + '/check-db', {
          method: 'POST',
          body: JSON.stringify({
            host: document.getElementById('dbHost').value.trim(),
            port: parseInt(document.getElementById('dbPort').value, 10) || 3306,
            username: document.getElementById('dbUser').value.trim(),
            password: document.getElementById('dbPassword').value,
            database: document.getElementById('dbName').value.trim(),
            createDatabase: document.getElementById('dbCreate').checked,
          }),
        });
        if (res.ok) {
          showMsg('step2Msg', res.created ? 'Veritabanı oluşturuldu ve bağlantı başarılı.' : 'Bağlantı başarılı.', 'ok');
        } else {
          showMsg('step2Msg', res.message || 'Bağlantı başarısız.', 'err');
        }
      } catch (err) {
        showMsg('step2Msg', err.message || 'İstek başarısız.', 'err');
      }
      btn.disabled = false;
      btn.textContent = 'Bağlantıyı test et';
    });

    document.getElementById('btnRun').addEventListener('click', async () => {
      const jwt = document.getElementById('jwtSecret').value.trim();
      const appUrl = document.getElementById('appUrl').value.trim();
      if (!jwt || jwt.length < 16) {
        showMsg('step5Msg', 'JWT gizli anahtar en az 16 karakter olmalı.', 'err');
        return;
      }
      if (!appUrl) {
        showMsg('step5Msg', 'Uygulama URL girin.', 'err');
        return;
      }
      hideMsg('step5Msg');
      document.getElementById('step5Log').classList.remove('hidden');
      const logEl = document.getElementById('step5Log');
      const appendLog = (t) => { logEl.textContent += t + '\n'; logEl.scrollTop = logEl.scrollHeight; };
      const btn = document.getElementById('btnRun');
      btn.disabled = true;
      btn.textContent = 'Kuruluyor…';

      const frontendUrl = document.getElementById('frontendUrl').value.trim() || appUrl;
      const config = {
        DB_HOST: document.getElementById('dbHost').value.trim(),
        DB_PORT: parseInt(document.getElementById('dbPort').value, 10) || 3306,
        DB_USERNAME: document.getElementById('dbUser').value.trim(),
        DB_PASSWORD: document.getElementById('dbPassword').value,
        DB_DATABASE: document.getElementById('dbName').value.trim(),
        JWT_SECRET: jwt,
        JWT_EXPIRES_IN: '1d',
        MAIL_HOST: document.getElementById('mailHost').value.trim() || undefined,
        MAIL_PORT: parseInt(document.getElementById('mailPort').value, 10) || 587,
        MAIL_USER: document.getElementById('mailUser').value.trim() || undefined,
        MAIL_PASSWORD: document.getElementById('mailPassword').value || undefined,
        MAIL_FROM: document.getElementById('mailFrom').value.trim() || undefined,
        PORT: parseInt(document.getElementById('port').value, 10) || 3001,
        APP_URL: appUrl.replace(/\/$/, ''),
        FRONTEND_URL: frontendUrl.replace(/\/$/, ''),
      };

      try {
        appendLog('1. Config yazılıyor...');
        const saveRes = await fetchJson(API + '/save-config', { method: 'POST', body: JSON.stringify(config) });
        if (!saveRes.ok) throw new Error(saveRes.message || 'Config yazılamadı.');
        appendLog('   Tamam.');

        appendLog('2. Veritabanı şeması oluşturuluyor...');
        const schemaRes = await fetchJson(API + '/run-schema', { method: 'POST' });
        if (!schemaRes.ok) throw new Error(schemaRes.message || 'Şema oluşturulamadı.');
        appendLog('   Tamam.');

        appendLog('3. Frontend derleniyor (birkaç dakika sürebilir)...');
        const buildRes = await fetchJson(API + '/build-frontend', { method: 'POST' });
        if (buildRes.log) appendLog(buildRes.log);
        if (!buildRes.ok) {
          appendLog('   Uyarı: ' + (buildRes.message || 'Build başarısız.') + ' Sunucuda manuel: cd frontend && npm run build');
        } else {
          appendLog('   Tamam.');
        }

        document.getElementById('step5Done').classList.remove('hidden');
        document.getElementById('linkLogin').href = appUrl.replace(/\/$/, '') + '/giris';
        showMsg('step5Msg', 'Kurulum başarıyla tamamlandı.', 'ok');
      } catch (err) {
        showMsg('step5Msg', err.message || 'Kurulum sırasında hata.', 'err');
        appendLog('HATA: ' + (err.message || err));
      }
      btn.disabled = false;
      btn.textContent = 'Kurulumu başlat';
    });
  </script>
</body>
</html>
